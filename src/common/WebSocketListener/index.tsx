import { useEffect } from "react";
import { useDispatch } from "react-redux";
import { useCookies } from "react-cookie";

import { applyRemoteProductUpdate } from "./actions";
import WebsocketConnection from "../../services/websockets";
import { UpdateProductNotification } from "./types";
import { setCartUpdatedProduct } from "../../modules/Cart/actions";
import { cartIdCookie } from "../../modules/Cart/constants";

const WebSocketListener = () => {
  const dispatch = useDispatch();

  const [cookies] = useCookies();

  useEffect(() => {
    const instance = WebsocketConnection.getInstance();

    instance.socket.on(
      "productUpdated",
      ({ _id, delta, cartId }: UpdateProductNotification) => {
        if (cookies[cartIdCookie] === cartId) {
          dispatch(applyRemoteProductUpdate({ _id, delta, cartId }));
          dispatch(setCartUpdatedProduct({ id: _id, delta }));
        } else {
          dispatch(applyRemoteProductUpdate({ _id, delta }));
        }
      }
    );

    return () => {
      instance.socket.close();
    };
  }, [dispatch, cookies]);

  return null;
};

export default WebSocketListener;
